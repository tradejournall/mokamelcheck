<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…ØµØ±Ù Ù…Ú©Ù…Ù„â€ŒÙ‡Ø§ - Ù‚ÙˆÛŒ Ù¾Ù†Ø¬Ù‡</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
  <style>
    body {
      font-family: sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
      color: #2c3e50;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    th, td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: #3498db;
      color: white;
    }
    .note {
      font-size: 0.9em;
      color: #555;
    }
    .taken {
      background-color: #d1f7c4 !important;
    }
    button {
      padding: 6px 12px;
      background-color: #27ae60;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      margin: 2px;
    }
    button:hover {
      background-color: #219150;
    }
    .dark-mode {
      background-color: #121212;
      color: white;
    }
    .dark-mode table {
      background: #1e1e1e;
      color: white;
    }
    .dark-mode th {
      background: #222;
    }
    input, select {
      padding: 8px;
      width: 100%;
      margin-bottom: 10px;
    }
    .form-section, .chart-container {
      background: white;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-top: 30px;
    }
    @media (max-width: 600px) {
      th, td {
        font-size: 0.8em;
        padding: 8px;
      }
    }
  </style>
</head>


<body>
  

<h1>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…ØµØ±Ù Ù…Ú©Ù…Ù„â€ŒÙ‡Ø§</h1>
<h2>Ù‚ÙˆÛŒ Ù¾Ù†Ø¬Ù‡</h2>

<!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
<div style="text-align:center;">
  <button onclick="toggleDarkMode()">ØªØºÛŒÛŒØ± Ø­Ø§Ù„Øª ØªØ§Ø±ÛŒÚ©/Ø±ÙˆØ´Ù†</button>
  <input type="date" id="datePicker" onchange="selectDate()">
</div>

<div style="text-align:center; margin: 20px;">
  <h3>Ø³Ø§Ø¹Øª ÙØ¹Ù„ÛŒ:</h3>
  <p id="clock" style="font-size: 1.5em; font-weight: bold;"></p>
</div>

<script>
  function updateClock() {
    const now = new Date();
    const options = { 
      hour: '2-digit', 
      minute: '2-digit', 
      second: '2-digit',
      timeZone: 'Asia/Tehran',
      localeMatcher: 'best fit'
    };
    const formatter = new Intl.DateTimeFormat('fa-IR', options);
    const parts = Object.fromEntries(
      formatter.formatToParts(now).map(part => [part.type, part.value])
    );
    const timeString = `${parts.hour}:${parts.minute}:${parts.second}`;
    document.getElementById('clock').textContent = timeString;
  }

  setInterval(updateClock, 1000);
  updateClock(); // Ø§ÙˆÙ„ÛŒÙ† Ø¨Ø§Ø± ÙÙˆØ±Ø§Ù‹ Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡Ø¯
</script>

<!-- Ù…ÙˆØ²ÛŒÚ© Ù¾Ù„ÛŒØ± -->
<div class="form-section">
  <h2>Ù…ÙˆØ²ÛŒÚ© Ù¾Ù„ÛŒØ±</h2>
  <input type="file" id="audioFileInput" accept="audio/*" multiple>
  <div style="margin-top: 10px;">
    <audio id="localAudioPlayer" controls style="width: 100%;"></audio>
  </div>
  <div style="display:flex; justify-content:space-between; margin-top:10px;">
    <button onclick="prevTrack()">Ù‚Ø¨Ù„ÛŒ</button>
    <button onclick="nextTrack()">Ù†Ú©Ø³Øª</button>
    <label><input type="checkbox" id="repeatToggle"> Ø±ÛŒÙ¾ÛŒØª</label>
  </div>
</div>

<script>
  const audioInput = document.getElementById('audioFileInput');
  const audioPlayer = document.getElementById('localAudioPlayer');
  const repeatToggle = document.getElementById('repeatToggle');

  let audioFiles = [];
  let currentTrackIndex = 0;

  // Ø§Ù†ØªØ®Ø§Ø¨ ÙØ§ÛŒÙ„(Ù‡Ø§)
  audioInput.addEventListener('change', function () {
    const files = Array.from(this.files);
    if (!files.length) return;

    audioFiles = files.map(file => ({
      name: file.name,
      url: URL.createObjectURL(file)
    }));

    currentTrackIndex = 0;
    playCurrentTrack();
  });

  // Ù¾Ø®Ø´ Ø¢Ù‡Ù†Ú¯ ÙØ¹Ù„ÛŒ
  function playCurrentTrack() {
    if (!audioFiles.length) return;
    audioPlayer.src = audioFiles[currentTrackIndex].url;
    audioPlayer.play();
  }

  // Ù‚Ø¨Ù„ÛŒ
  function prevTrack() {
    if (!audioFiles.length) return;
    currentTrackIndex = (currentTrackIndex - 1 + audioFiles.length) % audioFiles.length;
    playCurrentTrack();
  }

  // Ù†Ú©Ø³Øª
  function nextTrack() {
    if (!audioFiles.length) return;
    currentTrackIndex = (currentTrackIndex + 1) % audioFiles.length;
    playCurrentTrack();
  }

  // Ø±ÛŒÙ¾ÛŒØª
  audioPlayer.addEventListener('ended', () => {
    if (repeatToggle.checked) {
      playCurrentTrack(); // ØªÚ©Ø±Ø§Ø±
    } else {
      nextTrack(); // Ù†Ú©Ø³Øª
    }
  });
</script>

<!-- Ø¬Ø³ØªØ¬Ùˆ Ùˆ Ù†Ø§ÙˆØ¨Ø±ÛŒ -->
<div class="navigation" style="display:flex; justify-content:space-between; margin-top:20px;">
  <button onclick="changeDay(-1)">Ø±ÙˆØ² Ù‚Ø¨Ù„</button>
  <div id="currentDayDisplay"></div>
  <button onclick="changeDay(1)">Ø±ÙˆØ² Ø¨Ø¹Ø¯</button>
</div>
<input type="text" id="searchInput" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù…Ú©Ù…Ù„â€ŒÙ‡Ø§..." onkeyup="filterSupplements()">

<!-- Ø¬Ø¯ÙˆÙ„ Ù…Ú©Ù…Ù„â€ŒÙ‡Ø§ -->
<table id="supplementTable">
  <thead>
    <tr>
      <th>Ø²Ù…Ø§Ù†</th>
      <th>Ù…Ú©Ù…Ù„</th>
      <th>ØªÙˆØ¶ÛŒØ­Ø§Øª</th>
      <th>ÙˆØ¶Ø¹ÛŒØª</th>
      <th>ÙˆÛŒØ±Ø§ÛŒØ´</th>
    </tr>
  </thead>
  <tbody id="supplementBody"></tbody>
</table>

<!-- Ù†Ù…ÙˆØ¯Ø§Ø± -->
<div class="chart-container">
  <canvas id="progressChart" width="400" height="150"></canvas>
</div>

<!-- ØªØ§Ø±ÛŒØ®Ú†Ù‡ -->
<div id="historySection">
  <h2>ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…ØµØ±Ù</h2>
  <table>
    <thead>
      <tr><th colspan="5">Ø«Ø¨Øª Ù…ÙˆØ§Ø±Ø¯ Ù…ØµØ±Ù Ø´Ø¯Ù‡</th></tr>
    </thead>
    <tbody id="historyBody"></tbody>
  </table>
</div>

<!-- ÙØ±Ù… Ø§ÙØ²ÙˆØ¯Ù† Ù…Ú©Ù…Ù„ -->
<div class="form-section">
  <h2>Ø§ÙØ²ÙˆØ¯Ù† Ù…Ú©Ù…Ù„ Ø¬Ø¯ÛŒØ¯</h2>
  <input type="text" id="nameInput" placeholder="Ù†Ø§Ù… Ù…Ú©Ù…Ù„">
  <input type="text" id="timeInput" placeholder="Ø²Ù…Ø§Ù† Ù…ØµØ±Ù (Ù…Ø«Ù„Ø§Ù‹ ØµØ¨Ø­ Û¹)">
  <input type="text" id="noteInput" placeholder="Ù†Ú©Ø§Øª Ù…ØµØ±Ù">
  <label><input type="checkbox" id="dailyRepeat"> Ù‡Ø± Ø±ÙˆØ² ØªÚ©Ø±Ø§Ø± Ø´ÙˆØ¯ØŸ</label>
  <button onclick="addSupplement()">Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ Ø¬Ø¯ÙˆÙ„</button>
  <button onclick="exportToCSV()">Ø®Ø±ÙˆØ¬ÛŒ CSV</button>
  <button onclick="window.print()">Ú†Ø§Ù¾ Ø¬Ø¯ÙˆÙ„</button>
</div>

<!-- ÙØ±Ù… BMI Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ -->
<div class="form-section">
  <h2>Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ</h2>
  <input type="number" id="heightInput" placeholder="Ù‚Ø¯ (cm)">
  <input type="number" id="weightInput" placeholder="ÙˆØ²Ù† (kg)">
  <button onclick="calculateBMI()">Ù…Ø­Ø§Ø³Ø¨Ù‡ BMI</button>
  <p id="bmiResult"></p>
  <button onclick="suggestSupplement()">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…Ú©Ù…Ù„</button>
  <p id="supplementSuggestion"></p>
</div>

<script>
  let supplementPages = [[]];
  let currentDay = 0;
  let chart;

  function escapeForHTML(str) {
    return encodeURIComponent(str).replace(/'/g, "%27");
  }

  function decodeHTMLEntities(str) {
    const txt = document.createElement('textarea');
    txt.innerHTML = str;
    return txt.value;
  }

  function renderDayLabel() {
    document.getElementById('currentDayDisplay').innerText = `Ø±ÙˆØ² ${currentDay + 1}`;
  }

  function loadTable() {
    const tbody = document.getElementById('supplementBody');
    tbody.innerHTML = '';
    supplementPages[currentDay].forEach((supp, index) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${supp.time}</td>
        <td>${supp.name}</td>
        <td class="note">${supp.note}</td>
        <td><button onclick="markTaken('${escapeForHTML(supp.name)}', '${escapeForHTML(supp.time)}')">Ø®ÙˆØ±Ø¯Ù…</button></td>
        <td>
          <button onclick="editSupplement(${index})">âœï¸</button>
          <button onclick="deleteSupplement(${index})">ğŸ—‘</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    renderDayLabel();
    updateChart();
    saveData();
  }

  window.markTaken = function(encodedName, encodedTime) {
    const name = decodeURIComponent(encodedName);
    const time = decodeURIComponent(encodedTime);

    const now = new Date();
    const date = now.toLocaleDateString('fa-IR');
    const hour = now.toLocaleTimeString('fa-IR');

    const historyRow = document.createElement('tr');
    historyRow.innerHTML = `<td colspan="5">${name} Ø¯Ø± ${time} â€” ${date} Ø³Ø§Ø¹Øª ${hour}</td>`;
    document.getElementById('historyBody').appendChild(historyRow);

    const rows = document.querySelectorAll('#supplementBody tr');
    rows.forEach(row => {
      const cells = row.querySelectorAll('td');
      if (cells[0] && cells[1] && cells[0].textContent === time && cells[1].textContent === name) {
        row.classList.add('taken');
      }
    });

    checkDayCompletion();
    playSound();
    saveData();
  }

  function calculateBMI() {
    const height = parseFloat(document.getElementById('heightInput').value) / 100;
    const weight = parseFloat(document.getElementById('weightInput').value);
    if (!isNaN(height) && !isNaN(weight)) {
      const bmi = (weight / (height * height)).toFixed(1);
      document.getElementById('bmiResult').innerText = `Ø´Ø§Ø®Øµ ØªÙˆØ¯Ù‡ Ø¨Ø¯Ù†ÛŒ (BMI): ${bmi}`;
    }
  }

  function suggestSupplement() {
    const height = parseFloat(document.getElementById('heightInput').value) / 100;
    const weight = parseFloat(document.getElementById('weightInput').value);
    if (!isNaN(height) && !isNaN(weight)) {
      const bmi = weight / (height * height);
      let suggestion = "";
      if (bmi < 18.5) suggestion = "ÙˆÛŒØªØ§Ù…ÛŒÙ† DØŒ Ú©Ù„Ø³ÛŒÙ…ØŒ Ø§Ù…Ú¯Ø§-Û³";
      else if (bmi >= 25) suggestion = "ÙÛŒØ¨Ø±ØŒ Ú©Ø±ÙˆÙ…ØŒ ÙˆÛŒØªØ§Ù…ÛŒÙ† B";
      else suggestion = "ÙˆÛŒØªØ§Ù…ÛŒÙ† CØŒ Ù…Ù†ÛŒØ²ÛŒÙ…ØŒ Ø¢Ù†ØªÛŒ Ø§Ú©Ø³ÛŒØ¯Ø§Ù†";
      document.getElementById('supplementSuggestion').innerText = `Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…Ú©Ù…Ù„: ${suggestion}`;
    }
  }

  function addSupplement() {
    const name = document.getElementById('nameInput').value.trim();
    const time = document.getElementById('timeInput').value.trim();
    const note = document.getElementById('noteInput').value.trim();
    const dailyRepeat = document.getElementById('dailyRepeat').checked;
    if (name && time) {
      supplementPages[currentDay].push({ name, time, note, dailyRepeat });
      loadTable();
      document.getElementById('nameInput').value = '';
      document.getElementById('timeInput').value = '';
      document.getElementById('noteInput').value = '';
      document.getElementById('dailyRepeat').checked = false;
    }
  }

  function editSupplement(index) {
    const supp = supplementPages[currentDay][index];
    document.getElementById('nameInput').value = supp.name;
    document.getElementById('timeInput').value = supp.time;
    document.getElementById('noteInput').value = supp.note;
    document.getElementById('dailyRepeat').checked = !!supp.dailyRepeat;
    deleteSupplement(index);
  }

  function deleteSupplement(index) {
    supplementPages[currentDay].splice(index, 1);
    loadTable();
  }

  function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
  }

  function changeDay(offset) {
    currentDay += offset;
    if (currentDay < 0) currentDay = 0;
    if (!supplementPages[currentDay]) supplementPages[currentDay] = [];
    loadTable();
  }

  function filterSupplements() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#supplementBody tr');
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(term) ? '' : 'none';
    });
  }

  function exportToCSV() {
    let csv = 'Ø²Ù…Ø§Ù†,Ù…Ú©Ù…Ù„,ØªÙˆØ¶ÛŒØ­Ø§Øª\n';
    supplementPages[currentDay].forEach(supp => {
      csv += `"${supp.time}","${supp.name}","${supp.note}"\n`;
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "mokamel_" + (currentDay + 1) + ".csv";
    a.click();
  }

  function checkDayCompletion() {
    const takenCount = document.querySelectorAll('.taken').length;
    if (takenCount >= supplementPages[currentDay].length && supplementPages[currentDay].length > 0) {
      alert('Ù‡Ù…Ù‡ Ù…Ú©Ù…Ù„â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² Ù…ØµØ±Ù Ø´Ø¯Ù†Ø¯!');
      if (!supplementPages[currentDay + 1]) supplementPages[currentDay + 1] = [];
      currentDay++;
      loadTable();
    }
  }

  function updateChart() {
    const ctx = document.getElementById('progressChart').getContext('2d');
    const total = supplementPages[currentDay].length;
    const taken = document.querySelectorAll('.taken').length;
    const percent = Math.round((taken / total) * 100);

    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Ø¯Ø±ØµØ¯ Ù…ØµØ±Ù'],
        datasets: [{
          label: 'Ø¯Ø±ØµØ¯ Ù…ØµØ±Ù',
          data: [percent],
          backgroundColor: '#3498db'
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, max: 100 }
        }
      }
    });
  }

  function loadData() {
    const saved = localStorage.getItem('supplementPages');
    const day = localStorage.getItem('currentDay');
    const darkMode = localStorage.getItem('darkMode') === 'true';
    if (saved) supplementPages = JSON.parse(saved);
    if (day !== null) currentDay = parseInt(day);
    if (darkMode) document.body.classList.add('dark-mode');
  }

  function saveData() {
    localStorage.setItem('supplementPages', JSON.stringify(supplementPages));
    localStorage.setItem('currentDay', currentDay);
  }

  function selectDate() {
    const selected = new Date(document.getElementById('datePicker').value);
    const today = new Date();
    const diffDays = Math.floor((selected - today) / (1000 * 60 * 60 * 24));
    currentDay = diffDays;
    if (!supplementPages[currentDay]) supplementPages[currentDay] = [];
    loadTable();
  }

  function playSound() {
    const audio = new Audio('https://www.soundjay.com/buttons/sounds/beep-07.mp3'); 
    audio.play();
  }

  // Load Data
  loadData();

  if (!supplementPages[0] || supplementPages[0].length === 0) {
    supplementPages[0] = [
      { time: "ØµØ¨Ø­ (Û¹)", name: "Ú©Ù„Ø³ÛŒÙ… Ø¬ÙˆØ´Ø§Ù†", note: "Ø¨Ø§ Ø¢Ø¨ØŒ Ø¨Ø¯ÙˆÙ† Ú†Ø§ÛŒ ÛŒØ§ Ù‚Ù‡ÙˆÙ‡" },
      { time: "Ø¸Ù‡Ø± (Û±Û³)", name: "Ø§Ù…Ú¯Ø§ Û³", note: "Ù‡Ù…Ø±Ø§Ù‡ ØºØ°Ø§ÛŒ Ú†Ø±Ø¨" },
      { time: "Ø´Ø¨ (Û²Û²)", name: "Ù…Ú¯Ù†ÛŒÙÙˆØ±Øª", note: "Ù‚Ø¨Ù„ Ø®ÙˆØ§Ø¨ØŒ Ø¨Ø§ Ø¢Ø¨ ÛŒØ§ Ø´ÛŒØ±" },
      { time: "Ø¬Ù…Ø¹Ù‡ Ø¸Ù‡Ø±", name: "ÙˆÛŒØªØ§Ù…ÛŒÙ† D3 (ÛµÛ°,Û°Û°Û°)", note: "Ù‡ÙØªÙ‡â€ŒØ§ÛŒ Û± Ø¨Ø§Ø±ØŒ Ø¨Ø§ Ù†Ø§Ù‡Ø§Ø± Ú†Ø±Ø¨" }
    ];
  }

  loadTable();
</script>

</body>
</html>
